import React, { useState, useEffect, useRef } from 'react';
import { 
  Leaf, 
  Heart, 
  FlaskConical, 
  Calendar, 
  Camera, 
  Plus, 
  Trash2, 
  Search, 
  MapPin, 
  BookOpen, 
  Microscope,
  Coffee,
  Upload,
  X
} from 'lucide-react';

// --- Types & Interfaces ---

type Category = 'experiment' | 'fieldwork' | 'planning' | 'literature' | 'date' | 'travel' | 'milestone' | 'daily';

interface Entry {
  id: string;
  type: 'lab' | 'life';
  title: string;
  content: string;
  date: string;
  images: string[]; // Base64 strings
  category: Category;
  location?: string;
}

const LAB_CATEGORIES: { id: Category; label: string; icon: any }[] = [
  { id: 'experiment', label: 'Experiment', icon: FlaskConical },
  { id: 'fieldwork', label: 'Field Work', icon: Leaf },
  { id: 'planning', label: 'Planning', icon: Calendar },
  { id: 'literature', label: 'Literature', icon: BookOpen },
];

const LIFE_CATEGORIES: { id: Category; label: string; icon: any }[] = [
  { id: 'daily', label: 'Daily Life', icon: Coffee },
  { id: 'date', label: 'Date Night', icon: Heart },
  { id: 'travel', label: 'Travel', icon: MapPin },
  { id: 'milestone', label: 'Milestone', icon: Camera },
];

// --- Main Component ---

export default function App() {
  // State
  const [activeTab, setActiveTab] = useState<'lab' | 'life'>('lab');
  const [entries, setEntries] = useState<Entry[]>([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  
  // Form State
  const [formTitle, setFormTitle] = useState('');
  const [formContent, setFormContent] = useState('');
  const [formCategory, setFormCategory] = useState<Category>('experiment');
  const [formImages, setFormImages] = useState<string[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Load from LocalStorage on mount
  useEffect(() => {
    const saved = localStorage.getItem('growth_graphs_entries');
    if (saved) {
      try {
        setEntries(JSON.parse(saved));
      } catch (e) {
        console.error("Failed to parse entries", e);
      }
    } else {
      // Initial seed data for demonstration
      setEntries([
        {
          id: '1',
          type: 'lab',
          title: 'Arabidopsis Thaliana Growth Series A',
          content: 'Day 14: The specimens in the high-nitrogen group are showing 20% faster leaf expansion compared to the control group. Need to adjust the lighting schedule for next week.',
          date: new Date().toISOString(),
          images: [],
          category: 'experiment',
          location: 'Lab 304'
        },
        {
          id: '2',
          type: 'life',
          title: 'Weekend Hiking Trip',
          content: 'We finally took a break from the thesis writing to go hike the ridge. The view was incredible, and we even spotted some wild orchids!',
          date: new Date().toISOString(),
          images: [],
          category: 'travel',
          location: 'Blue Ridge Mountains'
        }
      ]);
    }
  }, []);

  // Save to LocalStorage whenever entries change
  useEffect(() => {
    localStorage.setItem('growth_graphs_entries', JSON.stringify(entries));
  }, [entries]);

  // Theme configuration based on active tab
  const theme = {
    primary: activeTab === 'lab' ? 'emerald' : 'rose',
    bg: activeTab === 'lab' ? 'bg-emerald-50' : 'bg-rose-50',
    headerBg: activeTab === 'lab' ? 'bg-emerald-900' : 'bg-rose-900',
    accent: activeTab === 'lab' ? 'text-emerald-600' : 'text-rose-600',
    button: activeTab === 'lab' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-rose-500 hover:bg-rose-600',
    border: activeTab === 'lab' ? 'border-emerald-200' : 'border-rose-200',
  };

  // Handlers
  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormImages(prev => [...prev, reader.result as string]);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const newEntry: Entry = {
      id: Date.now().toString(),
      type: activeTab,
      title: formTitle,
      content: formContent,
      category: formCategory,
      images: formImages,
      date: new Date().toISOString(),
      location: activeTab === 'lab' ? 'Laboratory' : 'Home', 
    };

    setEntries([newEntry, ...entries]);
    resetForm();
    setIsModalOpen(false);
  };

  const deleteEntry = (id: string) => {
    if (confirm('Are you sure you want to delete this entry?')) {
      setEntries(entries.filter(ent => ent.id !== id));
    }
  };

  const resetForm = () => {
    setFormTitle('');
    setFormContent('');
    setFormImages([]);
    setFormCategory(activeTab === 'lab' ? 'experiment' : 'daily');
  };

  const openModal = () => {
    resetForm();
    // Set default category based on current tab
    setFormCategory(activeTab === 'lab' ? 'experiment' : 'daily');
    setIsModalOpen(true);
  };

  // Filter entries
  const filteredEntries = entries.filter(entry => 
    entry.type === activeTab && 
    (entry.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
     entry.content.toLowerCase().includes(searchTerm.toLowerCase()))
  );

  // Renderers
  const renderCategoryIcon = (cat: Category) => {
    const allCats = [...LAB_CATEGORIES, ...LIFE_CATEGORIES];
    const found = allCats.find(c => c.id === cat);
    const Icon = found ? found.icon : Leaf;
    return <Icon size={16} className="mr-1" />;
  };

  const getCategoryLabel = (cat: Category) => {
    const allCats = [...LAB_CATEGORIES, ...LIFE_CATEGORIES];
    return allCats.find(c => c.id === cat)?.label || cat;
  };

  return (
    <div className={`min-h-screen transition-colors duration-500 ${theme.bg} font-sans`}>
      
      {/* --- Navigation Bar --- */}
      <nav className={`${theme.headerBg} text-white shadow-lg transition-colors duration-500 sticky top-0 z-10`}>
        <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center space-x-3">
              <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                {activeTab === 'lab' ? <Microscope size={24} /> : <Heart size={24} />}
              </div>
              <div>
                <h1 className="text-xl font-bold tracking-tight">Growth & Graphs</h1>
                <p className="text-xs text-white/80">Dr. Candidates Log</p>
              </div>
            </div>
            
            {/* Switcher */}
            <div className="flex bg-black/20 p-1 rounded-full backdrop-blur-sm">
              <button
                onClick={() => setActiveTab('lab')}
                className={`flex items-center px-4 py-1.5 rounded-full text-sm font-medium transition-all ${
                  activeTab === 'lab' ? 'bg-white text-emerald-900 shadow-sm' : 'text-white/70 hover:text-white'
                }`}
              >
                <FlaskConical size={14} className="mr-2" />
                Lab Notebook
              </button>
              <button
                onClick={() => setActiveTab('life')}
                className={`flex items-center px-4 py-1.5 rounded-full text-sm font-medium transition-all ${
                  activeTab === 'life' ? 'bg-white text-rose-900 shadow-sm' : 'text-white/70 hover:text-white'
                }`}
              >
                <Heart size={14} className="mr-2" />
                Our Journey
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* --- Main Content Area --- */}
      <main className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        {/* Header Stats & Search */}
        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div>
            <h2 className={`text-3xl font-bold ${activeTab === 'lab' ? 'text-emerald-900' : 'text-rose-900'}`}>
              {activeTab === 'lab' ? 'Research Timeline' : 'Couples Journal'}
            </h2>
            <p className={`${activeTab === 'lab' ? 'text-emerald-600' : 'text-rose-600'}`}>
              {activeTab === 'lab' 
                ? 'Documenting data, hypotheses, and breakthroughs.' 
                : 'Documenting dates, travels, and memories.'}
            </p>
          </div>

          <div className="flex items-center gap-3">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
              <input
                type="text"
                placeholder="Search entries..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10 pr-4 py-2 rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-opacity-50 w-full md:w-64 bg-white shadow-sm"
                style={{ 
                  //@ts-ignore 
                  '--tw-ring-color': activeTab === 'lab' ? '#059669' : '#e11d48' 
                }}
              />
            </div>
            <button
              onClick={openModal}
              className={`${theme.button} text-white px-4 py-2 rounded-full shadow-lg flex items-center font-medium transition-transform hover:scale-105 active:scale-95`}
            >
              <Plus size={18} className="mr-2" />
              New Entry
            </button>
          </div>
        </div>

        {/* Empty State */}
        {filteredEntries.length === 0 && (
          <div className="text-center py-20 opacity-60">
            <div className={`inline-block p-6 rounded-full mb-4 ${activeTab === 'lab' ? 'bg-emerald-100 text-emerald-400' : 'bg-rose-100 text-rose-400'}`}>
              <BookOpen size={48} />
            </div>
            <h3 className="text-xl font-medium text-gray-900">No entries found</h3>
            <p className="text-gray-500 mt-1">Start documenting your {activeTab === 'lab' ? 'research' : 'memories'} today.</p>
          </div>
        )}

        {/* Entries Grid/List */}
        <div className="grid grid-cols-1 gap-6">
          {filteredEntries.map((entry) => (
            <div 
              key={entry.id} 
              className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow duration-300"
            >
              <div className="p-6">
                <div className="flex justify-between items-start">
                  <div className="flex items-center gap-3 mb-3">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      activeTab === 'lab' ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'
                    }`}>
                      {renderCategoryIcon(entry.category)}
                      {getCategoryLabel(entry.category)}
                    </span>
                    <span className="text-gray-400 text-sm flex items-center">
                      <Calendar size={12} className="mr-1" />
                      {new Date(entry.date).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </span>
                  </div>
                  
                  <button 
                    onClick={() => deleteEntry(entry.id)}
                    className="text-gray-400 hover:text-red-500 transition-colors"
                  >
                    <Trash2 size={16} />
                  </button>
                </div>

                <h3 className="text-xl font-bold text-gray-900 mb-2">{entry.title}</h3>
                
                <div className="prose prose-sm max-w-none text-gray-600 whitespace-pre-wrap mb-4">
                  {entry.content}
                </div>

                {/* Image Gallery */}
                {entry.images.length > 0 && (
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-4">
                    {entry.images.map((img, idx) => (
                      <div key={idx} className="relative aspect-square rounded-lg overflow-hidden bg-gray-100">
                        <img src={img} alt="Entry attachment" className="w-full h-full object-cover" />
                      </div>
                    ))}
                  </div>
                )}

                {/* Footer Metadata */}
                {entry.location && (
                  <div className="mt-4 pt-4 border-t border-gray-50 flex items-center text-xs text-gray-400 font-medium uppercase tracking-wide">
                     <MapPin size={12} className="mr-1" />
                     {entry.location}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>

      </main>

      {/* --- Create Modal --- */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className={`p-6 ${theme.headerBg} text-white flex justify-between items-center sticky top-0 z-10`}>
              <h3 className="text-lg font-bold flex items-center">
                {activeTab === 'lab' ? <FlaskConical className="mr-2" size={20}/> : <Heart className="mr-2" size={20}/>}
                New {activeTab === 'lab' ? 'Lab Entry' : 'Journal Entry'}
              </h3>
              <button onClick={() => setIsModalOpen(false)} className="text-white/70 hover:text-white">
                <X size={24} />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="p-6 space-y-6">
              
              {/* Category Selection */}
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                {(activeTab === 'lab' ? LAB_CATEGORIES : LIFE_CATEGORIES).map((cat) => (
                  <button
                    key={cat.id}
                    type="button"
                    onClick={() => setFormCategory(cat.id)}
                    className={`flex flex-col items-center justify-center p-3 rounded-lg border-2 transition-all ${
                      formCategory === cat.id 
                        ? `${activeTab === 'lab' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-rose-500 bg-rose-50 text-rose-700'}` 
                        : 'border-gray-100 text-gray-500 hover:border-gray-200'
                    }`}
                  >
                    <cat.icon size={20} className="mb-1" />
                    <span className="text-xs font-medium">{cat.label}</span>
                  </button>
                ))}
              </div>

              {/* Inputs */}
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                  <input
                    required
                    type="text"
                    value={formTitle}
                    onChange={(e) => setFormTitle(e.target.value)}
                    placeholder={activeTab === 'lab' ? "e.g., PCR Protocol Revision 3" : "e.g., Anniversary Dinner"}
                    className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-opacity-50 transition-all"
                    style={{ 
                      //@ts-ignore 
                      '--tw-ring-color': activeTab === 'lab' ? '#059669' : '#e11d48' 
                    }}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Details</label>
                  <textarea
                    required
                    rows={6}
                    value={formContent}
                    onChange={(e) => setFormContent(e.target.value)}
                    placeholder={activeTab === 'lab' ? "Methodology, observations, results..." : "How did the day go? What was the highlight?"}
                    className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-opacity-50 transition-all resize-none"
                    style={{ 
                      //@ts-ignore 
                      '--tw-ring-color': activeTab === 'lab' ? '#059669' : '#e11d48' 
                    }}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                  <div className="flex items-center space-x-4">
                    <button
                      type="button"
                      onClick={() => fileInputRef.current?.click()}
                      className="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors text-sm"
                    >
                      <Upload size={16} className="mr-2" />
                      Add Image
                    </button>
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept="image/*"
                      className="hidden"
                      onChange={handleImageUpload}
                    />
                    <span className="text-xs text-gray-400">
                      {formImages.length} image(s) selected
                    </span>
                  </div>
                  
                  {/* Image Previews */}
                  {formImages.length > 0 && (
                    <div className="flex gap-2 mt-3 overflow-x-auto pb-2">
                      {formImages.map((img, i) => (
                        <div key={i} className="relative shrink-0 w-20 h-20 rounded-md overflow-hidden border border-gray-200 group">
                          <img src={img} alt="Preview" className="w-full h-full object-cover" />
                          <button
                            type="button"
                            onClick={() => setFormImages(formImages.filter((_, idx) => idx !== i))}
                            className="absolute inset-0 bg-black/50 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              <div className="pt-4 border-t border-gray-100 flex justify-end gap-3">
                <button
                  type="button"
                  onClick={() => setIsModalOpen(false)}
                  className="px-5 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className={`px-6 py-2 text-white font-medium rounded-lg shadow-md transition-all hover:scale-105 active:scale-95 ${theme.button}`}
                >
                  Save Entry
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

    </div>
  );
}